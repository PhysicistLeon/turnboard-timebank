# Спецификация продукта (Android, Flet/Python)
Версия: v1.0 (draft)

Цель: документ для реализации приложения без привязки к конкретной архитектуре.

---
## 1) Цель приложения
Приложение — **инструмент ведущего/стола** для настольных игр, который:
- ограничивает и распределяет **банк времени на партию** между игроками,
- делает передачу хода “в один тап”,
- поддерживает **тех.паузы** и **административные корректировки** (под паролем),
- ведёт **человеческий лог** всех значимых событий одной строкой на событие,
- работает **Android-only**, с фиксированной ориентацией и запретом гашения экрана во время активной игры.

---
## 2) Основные концепции и определения
### 2.1 Игрок (Player)
У игрока есть:
- `name` — строка (уникальная в рамках партии; используется как идентификатор в логах)
- `color` — цвет игрока (например, RGB/HEX)
- `sound_tap` — имя файла звука на нажатие большой кнопки
- (опционально) `sound_warn` — имя файла для предупреждений (если предусмотрите отдельный звук на игрока; иначе используется общий warn-звук в правилах)

### 2.2 Партия (Game session)
Партия описывается:
- `game_id` — уникальный идентификатор сессии (например, по времени создания)
- `order` — список игроков в порядке очереди (список имён)
- `order_dir` — направление очереди: `clockwise` / `counterclockwise`
- `rules` — правила тайм-контроля (см. ниже)
- `bank[name]` — текущий остаток банка у каждого игрока (внутри может быть высокая точность; UI показывает секунды)

### 2.3 Правила (Rules)
- `bank_initial` — начальный банк времени каждого игрока на партию
- `cooldown` — “разогрев” в начале каждого хода игрока; в этот период банк **не уменьшается**
- `warn_every` — интервал предупреждений о длинном ходе (после окончания cooldown), например 60 секунд
- `warn_sound` — имя файла звука предупреждения (если не используете per-player `sound_warn`)
- `blink_min_hz = 1/60 Гц`, `blink_max_hz = 1 Гц` — диапазон частоты “мигания” (визуальная пульсация)

### 2.4 Состояния приложения
- **Setup (до старта партии)**: можно свободно править игроков/правила/очередь без пароля.
- **Running (игра идёт)**: активен таймер текущего игрока (или его cooldown).
- **Tech Pause (тех.пауза)**: таймер заморожен; доступен экран настроек и возможны админ-правки (под паролем).
- **Admin Mode (внутренний режим внутри Tech Pause)**: активен только после успешного ввода пароля; даёт право менять настройки после старта партии.

---
## 3) Бизнес-логика
### 3.1 Время и отображение
- Внутреннее время считается с высокой точностью (можно субсекундно), но:
  - на UI таймер отображается строго в формате **MM:SS**.
  - если банк ушёл в минус (перерасход), отображение строго **-MM:SS** с ростом модуля времени.
- Источник истины — фактическая прошедшая дельта времени (не частота обновления UI).

> Обновлённый приоритет требований: формат `MM:SS/-MM:SS` является обязательным и имеет приоритет над предыдущими формулировками про отображение просто в секундах.

### 3.2 Ход игрока: cooldown + countdown
При начале хода игрока:
1. Состояние хода входит в фазу `cooldown` на `rules.cooldown`.
2. Во время cooldown:
   - UI показывает, что ход игрока активен
   - банк **не уменьшается**
   - предупреждения `warn_every` **не считаются**
3. По окончании cooldown:
   - начинается `countdown` (уменьшение банка игрока)

### 3.3 Предупреждения о длинном ходе
- После окончания cooldown отсчитывается “чистое время хода” (elapsed_no_cooldown).
- Каждый раз, когда elapsed_no_cooldown достигает кратного `warn_every` (60, 120, 180… секунд), проигрывается предупреждающий звук.
- Предупреждения:
  - не должны проигрываться во время тех.паузы
  - после выхода из тех.паузы продолжаются с корректным учётом уже накопленного elapsed_no_cooldown

### 3.4 Передача хода (основная большая кнопка)
При нажатии на большую кнопку в режиме Running:
1. Проигрывается `sound_tap` текущего игрока (если доступен).
2. Включается вибрация устройства.
3. Текущий ход завершается:
   - если был `countdown`, из банка списывается фактически прошедшее время в countdown
   - если был `cooldown`, списание = 0
4. Вычисляется следующий игрок:
   - используется текущий `order` и `order_dir`
5. Запускается ход следующего игрока (с его cooldown).

**Если банк игрока достиг 0:**
- Минимально корректная политика для v1:
  - подаеся визуальный сигнал “банк исчерпан” (например, надпись), без дополнительных звуков, идёт отрицательный отсчёт, кнопка становится черной

### 3.5 Тех.пауза
Тех.пауза может включаться:
- вручную кнопкой “Pause” на игровом экране
- автоматически при:
  - сворачивании приложения
  - звонке/потере фокуса/аналогичных системных событиях

При включении тех.паузы:
- текущий игрок **не меняется**
- состояние `cooldown/countdown` замораживается
- банк не уменьшается
- предупреждения не проигрываются

При выходе из тех.паузы:
- игра продолжается с тем же игроком и с тем же замороженным состоянием

### 3.6 Изменения настроек: до старта vs после старта
**До начала партии (Setup):**
- любые изменения игроков/очереди/правил разрешены без пароля.

**После начала партии (Tech Pause + Admin Mode):**
- любые изменения конфигурации считаются **административными** и требуют:
  - входа в Admin Mode (ввод пароля)
  - записи события в лог

Админ-изменения включают:
- изменение имени игрока
- изменение цвета игрока
- изменение звука игрока
- изменение банка игрока (корректировка)
- изменение списка очереди (перестановка)
- смена направления очереди
- изменение правил (`cooldown`, `warn_every`, etc.)
- `TURN_UNDO` (отмена передачи хода)

### 3.7 Перестановка очереди во время партии
При изменении порядка игроков (после старта партии):
- текущий игрок остаётся тем же
- “следующий игрок” после текущего определяется по **новому** порядку и текущему направлению

### 3.8 Смена направления очереди
При смене направления:
- текущий игрок не меняется
- “следующий” при следующей передаче хода вычисляется по новому направлению

### 3.9 TURN_UNDO (отмена передачи хода)
Админ-действие. Политика (зафиксирована):
- ссылка делается на **последний `TURN_END`**, который отменяют
- после undo:
  - активным снова становится игрок из `TURN_END.name`
  - банк игрока устанавливается в `TURN_END.bank_after`
  - фаза хода становится `countdown` (не cooldown)
  - накопленное “чистое время хода” восстанавливается так, чтобы предупреждения продолжились корректно

> Примечание: чтобы требования “легко восстановить логику” и корректность warn совпадали, в логе для `TURN_END` рекомендуется фиксировать `spent_no_cooldown`, а при undo использовать его для восстановления.

### 3.10 New Game
Кнопка “New Game” доступна из экрана настроек (во время паузы).
Поведение:
- создаётся новый `game_id` (новая сессия партии)
- банки всех игроков устанавливаются в `rules.bank_initial`
- порядок игроков/имена/цвета/звуки/правила остаются как в текущей конфигурации (если не задано иначе)
- запись в общий лог продолжается (один файл), но с новым `G=<game_id>`

---
## 4) Логирование (человеческий лог)
### 4.1 Общие требования к логу
- Один общий лог-файл для всех партий.
- Одна строка = одно событие.
- Каждое событие имеет:
  - timestamp (желательно ISO с мс)
  - последовательный номер `SEQ` (монотонный)
  - `game_id` (G=...)
  - тип события (`EVENT`)
  - параметры `key=value`
- Обязательно логируются:
  - `GAME_START` с полным порядком очереди и правилами
  - передачи хода `TURN_END` / `TURN_START`
  - тех.паузы on/off (и причины)
  - background/resume
  - все админ-действия (включая old/new)
  - смена направления, undo, new game

### 4.2 Лог изменений очереди
Требование: “важно указать начальную очередность и указывать если поменяли местами/переставили”.
- На старте: `GAME_START ... order="A,B,C" order_dir=...`
- При изменении: событие содержит `old="..." new="..."` (полные списки), комментарий может уточнять “swap”.

### 4.3 Звуки: если папка пустая/недоступна
Требование допускает два UX-режима:
- **Silent mode (по умолчанию для v1):** молча без звука, без блокировки игры.
- **Warning banner (опционально):** ненавязчивое предупреждение на экране настроек/игры, что звуки недоступны.

В любом случае:
- приложение не падает
- событие/ошибка фиксируется в логе (например `ERROR sound_unavailable`), чтобы объяснить отсутствие звука.

---
## 5) UI/UX спецификация
### 5.1 Общие UX принципы
- Минимум действий на столе: основной сценарий — один тап для передачи хода.
- Максимальная читаемость на расстоянии: крупные шрифты, высокий контраст.
- Фиксированная ориентация.
- Экран не гаснет в режиме Running.

### 5.2 Первый запуск (пароль)
**Сценарий:**
1. При первом запуске, если ini отсутствует:
   - показать экран создания пароля
   - требование: пароль сохраняется в ini в открытом виде
2. После сохранения пароля перейти в Setup.

### 5.3 Экран Setup (до старта партии)
Состав экрана:
- список игроков в порядке очереди:
  - имя
  - цвет (визуальный индикатор)
  - выбранный sound_tap (имя файла)
  - оставшийся банк (в Setup может показываться как `bank_initial`)
- элементы управления:
  - добавить/удалить игрока
  - изменить порядок (drag&drop или кнопки вверх/вниз)
  - редактировать имя/цвет/звук (с предпрослушиванием)
- блок правил:
  - bank_initial
  - cooldown
  - warn_every
  - warn_sound (если общий)
  - направление очереди (clockwise/counterclockwise)
- кнопка **Start Game**

Ограничения/валидации UX:
- имена игроков должны быть уникальны (показывать ошибку при конфликте)
- если звуковая папка недоступна/пуста — показывать пустой список звуков и (опционально) предупреждение

### 5.4 Экран Game (игра идёт)
**Главный элемент: большая кнопка:**
- занимает почти весь экран
- фон/акцент соответствует `color` текущего игрока
- внутри:
  - крупно `name`
  - крупно таймер (остаток банка, в секундах)
- визуальная пульсация:
  - цвет колеблется от чёрного к `color` и обратно
  - частота колебаний зависит от прогресса банка текущего игрока:
    - при полном банке ≈ `blink_min_hz` (1 цикл в 60 сек)
    - ближе к 0 → до `blink_max_hz` (1 цикл в 1 сек)
  - зависимость должна быть монотонной и плавной

**Вспомогательные элементы:**
- кнопка **Pause**:
  - включает TECH PAUSE и открывает экран настроек
- (опционально) индикатор направления очереди

**Поведение на tap:**
- проигрывание `sound_tap` текущего игрока (если доступно)
- вибрация
- переключение на следующего с запуском cooldown

**Системные события:**
- при background → автоматически тех.пауза, затем при возвращении остаёмся в паузе до явного Continue

### 5.5 Экран Tech Pause / Settings (во время партии)
Назначение: “пит-стоп” ведущего.
Содержимое:
- таблица игроков в текущем порядке очереди:
  - имя
  - цвет
  - остаток банка (секунды)
  - выбранные звуки (имена файлов)
- блок текущего состояния:
  - кто current
  - фаза (cooldown/countdown)
  - сколько осталось cooldown (если релевантно)
  - направление очереди
- кнопки:
  - **Continue**
  - **New Game**
  - **Admin actions**

**Admin mode UX:**
- кнопка “Admin mode” → запрос пароля
- после успешного ввода становятся доступны админ-правки:
  - изменение банка игрока
  - перестановка order
  - смена направления очереди
  - изменение правил
  - изменение имени/цвета/звука игроков
  - **Undo last turn**
- после завершения правок: кнопка “Exit admin mode” (или авто-выход при Continue)

### 5.6 Выбор звука (для tap и warn)
Сценарий:
- список файлов из специальной папки
- при выборе — кнопка “Preview”
- сохранить выбор в конфиге игрока/правил

Если папка недоступна/пуста:
- список пуст
- предупреждение опционально

---
## 6) Хранилище данных (без деталей реализации)
Все данные располагаются в одной папке, доступной приложению:
- ini/config приложения
- пресеты (по желанию)
- логи (один общий файл)
- возможно служебные файлы

Внешняя специальная папка со звуками:
- доступ только на чтение
- приложение использует только **имена файлов** в настройках и логах

---
## 7) Критерии готовности (acceptance criteria)
1. Можно создать пароль при первом запуске и перейти в Setup.
2. В Setup можно задать игроков (имя/цвет/звук), порядок, правила (банк/cooldown/warn_every), затем начать игру.
3. В режиме игры:
   - большая кнопка показывает имя+таймер, пульсирует по банку игрока
   - tap → звук+вибро+переключение хода
   - cooldown реализован (нет списания)
   - warn срабатывает каждые N секунд после cooldown
4. Pause открывает Tech Pause:
   - отображается остаток времени всех игроков
   - Continue продолжает с тем же игроком
5. Сворачивание/звонок переводит в tech pause автоматически.
6. После GAME_START любые изменения настроек доступны только в Admin Mode (по паролю) и логируются.
7. Изменение порядка очереди во время партии меняет “следующего” относительно current по новому списку.
8. Reverse direction работает и логируется.
9. Undo возвращает ход назад согласно зафиксированной политике.
10. New Game создаёт новый game_id и сбрасывает банки.
11. Лог содержит стартовые правила/очередь и все значимые события, включая изменения очереди (old/new).
